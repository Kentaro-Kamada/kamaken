<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>PIAACにおける標準誤差の推定 • kamaken</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="PIAACにおける標準誤差の推定">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">kamaken</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/easyLCA.html">こわくない潜在クラス</a></li>
    <li><a class="dropdown-item" href="../articles/Variance-estimation-in-PIAAC.html">PIAACにおける標準誤差の推定</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Kentaro-Kamada/kamaken/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>PIAACにおける標準誤差の推定</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Kentaro-Kamada/kamaken/blob/main/vignettes/Variance-estimation-in-PIAAC.Rmd" class="external-link"><code>vignettes/Variance-estimation-in-PIAAC.Rmd</code></a></small>
      <div class="d-none name"><code>Variance-estimation-in-PIAAC.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="はじめに">はじめに<a class="anchor" aria-label="anchor" href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"></a>
</h2>
<p>PIAACやPISAといった複雑な調査データでは特殊な方法で標準誤差を推定する必要がある。このノートでは、PIAACのデータを例に標準誤差の推定方法を紹介する。<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;StataでのPIAACの分析パッケージについては、以下の論文を参照&lt;br&gt;
Jakubowski, Maciej &amp;amp; Artur Pokropek, 2019, “piaactools: A program
for data analysis with PIAAC data,” &lt;em&gt;The Stata Journal&lt;/em&gt;, 19(1):
112-128. &lt;a href="https://doi.org/10.1177/1536867X19830909" class="external-link uri"&gt;https://doi.org/10.1177/1536867X19830909&lt;/a&gt;&lt;/p&gt;'><sup>1</sup></a></p>
<p>以下、</p>
<ol style="list-style-type: decimal">
<li>標準誤差の推定式を概観</li>
<li>平均値を例に、<code>srvyr</code>パッケージによる推定と手動での推定を比較</li>
<li>
<code>kamaken::gcom_jack</code>を利用した因果効果の推定</li>
</ol>
<p>を行う。</p>
</div>
<div class="section level2">
<h2 id="前準備">前準備<a class="anchor" aria-label="anchor" href="#%E5%89%8D%E6%BA%96%E5%82%99"></a>
</h2>
<div class="section level3">
<h3 id="パッケージ読み込み">パッケージ読み込み<a class="anchor" aria-label="anchor" href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://haven.tidyverse.org" class="external-link">haven</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://r-survey.r-forge.r-project.org/survey/" class="external-link">survey</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://gdfe.co/srvyr/" class="external-link">srvyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://kentaro-kamada.github.io/kamaken/">kamaken</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">kable</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/partial.html" class="external-link">partial</a></span><span class="op">(</span><span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="データ読み込み">データ読み込み<a class="anchor" aria-label="anchor" href="#%E3%83%87%E3%83%BC%E3%82%BF%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF"></a>
</h3>
<ul>
<li>PIAAC 1st cycleの日本データ（SPSS形式）
<ul>
<li><a href="https://webfs.oecd.org/piaac/puf-data/SPSS/prgjpnp1.sav" class="external-link uri">https://webfs.oecd.org/piaac/puf-data/SPSS/prgjpnp1.sav</a></li>
</ul>
</li>
<li>変数の名前を適宜変更しておく</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://haven.tidyverse.org/reference/read_spss.html" class="external-link">read_sav</a></span><span class="op">(</span><span class="st">'https://webfs.oecd.org/piaac/puf-data/SPSS/prgjpnp1.sav'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># 変数を絞る</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    country <span class="op">=</span> <span class="va">CNTRYID</span>, </span>
<span>    id <span class="op">=</span> <span class="va">SEQID</span>,</span>
<span>    age <span class="op">=</span> <span class="va">AGE_R</span>, </span>
<span>    gender <span class="op">=</span> <span class="va">GENDER_R</span>, </span>
<span>    region <span class="op">=</span> <span class="va">REG_TL2</span>, </span>
<span>    edu <span class="op">=</span> <span class="va">B_Q01a</span>, </span>
<span>    medu <span class="op">=</span> <span class="va">J_Q06b</span>, </span>
<span>    fedu <span class="op">=</span> <span class="va">J_Q07b</span>, </span>
<span>    numbooks <span class="op">=</span> <span class="va">J_Q08</span>,</span>
<span>    sampling_weight <span class="op">=</span> <span class="va">SPFWT0</span>, </span>
<span>    <span class="co"># 読解力、数的思考力、ITスキルのスコア</span></span>
<span>    <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">'^PV'</span><span class="op">)</span>, </span>
<span>    <span class="co"># Replicate weights</span></span>
<span>    <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="st">'SPFWT'</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">80</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="va">VEMETHOD</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># 変数名を小文字に変換</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename_with</a></span><span class="op">(</span><span class="va">str_to_lower</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html" class="external-link">as_factor</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">parse_double</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="co"># 年齢をカテゴリ化</span></span>
<span>    agegroup <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span></span>
<span>      <span class="va">age</span>,</span>
<span>      breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">20</span>, <span class="fl">25</span>, <span class="fl">30</span>, <span class="fl">35</span>, <span class="fl">40</span>, <span class="fl">45</span>, <span class="fl">50</span>, <span class="fl">55</span>, <span class="fl">60</span>, <span class="fl">65</span><span class="op">)</span>,</span>
<span>      labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'16-20'</span>, <span class="st">'21-25'</span>, <span class="st">'26-30'</span>, <span class="st">'31-35'</span>, <span class="st">'36-40'</span>, <span class="st">'41-45'</span>, <span class="st">'46-50'</span>, <span class="st">'51-55'</span>, <span class="st">'56-60'</span>, <span class="st">'61-65'</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># 大学卒業ダミー</span></span>
<span>    univ <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html" class="external-link">case_match</a></span><span class="op">(</span></span>
<span>      <span class="va">edu</span>,</span>
<span>      <span class="st">'No formal qualification or below ISCED 1'</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="st">'ISCED 2'</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="st">'ISCED 3C shorter than 2 years'</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="st">'ISCED 3C 2 years or more'</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="st">'ISCED 3A-B'</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="st">'ISCED 3 (without distinction A-B-C, 2y+)'</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="st">'ISCED 4 (without distinction A-B-C)'</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="st">'ISCED 5B'</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="st">'ISCED 5A, bachelor degree'</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="st">'ISCED 5A, master degree'</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="st">'ISCED 6'</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="st">'Foreign qualification'</span> <span class="op">~</span> <span class="cn">NA</span>,</span>
<span>      <span class="cn">NA</span> <span class="op">~</span> <span class="cn">NA</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="標準誤差の推定式">標準誤差の推定式<a class="anchor" aria-label="anchor" href="#%E6%A8%99%E6%BA%96%E8%AA%A4%E5%B7%AE%E3%81%AE%E6%8E%A8%E5%AE%9A%E5%BC%8F"></a>
</h2>
<ul>
<li>jackknife法による標準誤差</li>
</ul>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">E</mi></mrow><mi>θ</mi></msub><mo>=</mo><msqrt><mrow><mi>h</mi><munderover><mo>∑</mo><mrow><mi>r</mi><mo>=</mo><mn>1</mn></mrow><mi>R</mi></munderover><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>θ</mi><mo accent="true">̂</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>r</mi><mo stretchy="true" form="postfix">)</mo></mrow></msub><mo>−</mo><mover><mi>θ</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">
\mathrm{SE}_\theta = \sqrt{h\sum_{r=1}^{R} (\hat{\theta}_{(r)} - \hat{\theta})^2}
</annotation></semantics></math></p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>R</mi><annotation encoding="application/x-tex">R</annotation></semantics></math>：反復回数、replicate
weightの数（PIAACは80）</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>θ</mi><mo accent="true">̂</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>r</mi><mo stretchy="true" form="postfix">)</mo></mrow></msub><annotation encoding="application/x-tex">\hat{\theta}_{(r)}</annotation></semantics></math>：<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>r</mi><annotation encoding="application/x-tex">r</annotation></semantics></math>番目のreplicate
weightを用いた推定値</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>θ</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{\theta}</annotation></semantics></math>：全体の推定値（サンプリングウェイトを用いた推定値）</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>h</mi><annotation encoding="application/x-tex">h</annotation></semantics></math>：乗数、
Jackknife法のバリエーションによって異なる
<ul>
<li>JK1の場合は<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo>=</mo><mfrac><mrow><mi>R</mi><mo>−</mo><mn>1</mn></mrow><mi>R</mi></mfrac></mrow><annotation encoding="application/x-tex">h = \frac{R-1}{R}</annotation></semantics></math>
</li>
<li>JK2の場合は<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">h = 1</annotation></semantics></math>
</li>
</ul>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="平均値の推定">平均値の推定<a class="anchor" aria-label="anchor" href="#%E5%B9%B3%E5%9D%87%E5%80%A4%E3%81%AE%E6%8E%A8%E5%AE%9A"></a>
</h2>
<ul>
<li>点推定値</li>
<li>jackknife法による標準誤差</li>
</ul>
<p>の二つを推定する</p>
<div class="section level3">
<h3 id="packageによる推定">packageによる推定<a class="anchor" aria-label="anchor" href="#package%E3%81%AB%E3%82%88%E3%82%8B%E6%8E%A8%E5%AE%9A"></a>
</h3>
<ul>
<li>
<code>survey</code>パッケージ（のラッパーの<code>srvyr</code>パッケージ）を用いる</li>
<li>
<code>type</code>: 標準誤差の推定方法
<ul>
<li>PIAACでは<code>JK1</code>の国と<code>JK2</code>の国が混在（変数<code>VEMETHOD</code>にどちらを使用すれば良いかが書かれている）</li>
<li>日本は<code>JK2</code>で推定する</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_design</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># 調査デザインの設定</span></span>
<span>  <span class="fu"><a href="http://gdfe.co/srvyr/reference/as_survey_rep.html" class="external-link">as_survey_rep</a></span><span class="op">(</span></span>
<span>    weights <span class="op">=</span> <span class="va">sampling_weight</span>, </span>
<span>    repweights <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">'spfwt'</span><span class="op">)</span>, </span>
<span>    type <span class="op">=</span> <span class="st">'JK2'</span>,</span>
<span>    mse <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">result_literacy</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">df_design</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># 読解力の各PVごとに平均値と標準誤差を計算</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">'pvlit'</span><span class="op">)</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="http://gdfe.co/srvyr/reference/survey_mean.html" class="external-link">survey_mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> </span>
<span>  </span>
<span><span class="co"># 結果の整理</span></span>
<span><span class="va">package</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">result_literacy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename_with</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html" class="external-link">str_replace</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">'(\\d)$'</span>, <span class="st">'\\1_estimate'</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># 縦持ちに変換</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">'pvlit'</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'literacy'</span>, <span class="st">'.value'</span><span class="op">)</span>,</span>
<span>    names_pattern <span class="op">=</span> <span class="st">'(pvlit\\d{1,2})_(.+)'</span>,</span>
<span>  <span class="op">)</span> </span>
<span></span>
<span><span class="fu">kable</span><span class="op">(</span><span class="va">package</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">literacy</th>
<th align="right">estimate</th>
<th align="right">se</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">pvlit1</td>
<td align="right">296.468</td>
<td align="right">0.549</td>
</tr>
<tr class="even">
<td align="left">pvlit2</td>
<td align="right">296.143</td>
<td align="right">0.529</td>
</tr>
<tr class="odd">
<td align="left">pvlit3</td>
<td align="right">296.184</td>
<td align="right">0.543</td>
</tr>
<tr class="even">
<td align="left">pvlit4</td>
<td align="right">296.111</td>
<td align="right">0.541</td>
</tr>
<tr class="odd">
<td align="left">pvlit5</td>
<td align="right">296.172</td>
<td align="right">0.522</td>
</tr>
<tr class="even">
<td align="left">pvlit6</td>
<td align="right">296.936</td>
<td align="right">0.543</td>
</tr>
<tr class="odd">
<td align="left">pvlit7</td>
<td align="right">295.561</td>
<td align="right">0.481</td>
</tr>
<tr class="even">
<td align="left">pvlit8</td>
<td align="right">296.827</td>
<td align="right">0.518</td>
</tr>
<tr class="odd">
<td align="left">pvlit9</td>
<td align="right">296.188</td>
<td align="right">0.521</td>
</tr>
<tr class="even">
<td align="left">pvlit10</td>
<td align="right">295.832</td>
<td align="right">0.542</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="手作業による推定">手作業による推定<a class="anchor" aria-label="anchor" href="#%E6%89%8B%E4%BD%9C%E6%A5%AD%E3%81%AB%E3%82%88%E3%82%8B%E6%8E%A8%E5%AE%9A"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">point_estimate</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">sampling_weight</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">'(pvlit|spfwt)'</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">'pvlit'</span><span class="op">)</span>, </span>
<span>      \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span><span class="va">x</span>, w <span class="op">=</span> <span class="va">sampling_weight</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>      .names <span class="op">=</span> <span class="st">'{.col}_estimate'</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">'pvlit'</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'literacy'</span>, <span class="st">'.value'</span><span class="op">)</span>,</span>
<span>    names_pattern <span class="op">=</span> <span class="st">'(pvlit\\d{1,2})_(.+)'</span>,</span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span><span class="co"># jackknife法に用いるウェイト（80個）</span></span>
<span><span class="va">jackweight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">'spfwt'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">jack_estimate</span> <span class="op">&lt;-</span></span>
<span>  <span class="co"># 各ウェイトを用いて、それぞれのPVの平均値を計算</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span></span>
<span>    <span class="va">jackweight</span>, \<span class="op">(</span><span class="va">weight</span><span class="op">)</span> </span>
<span>    <span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span></span>
<span>          <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">'pvlit'</span><span class="op">)</span>,</span>
<span>          \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span><span class="va">x</span>, w <span class="op">=</span> <span class="va">weight</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>          .names <span class="op">=</span> <span class="st">'{.col}_jack'</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">'replicate'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">'pvlit'</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'literacy'</span>, <span class="st">'.value'</span><span class="op">)</span>,</span>
<span>    names_pattern <span class="op">=</span> <span class="st">'(pvlit\\d{1,2})_(.+)'</span>,</span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">handmade</span> <span class="op">&lt;-</span> </span>
<span>  <span class="co"># 点推定値にジャックナイフウェイトを用いた推定値を結合</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">point_estimate</span>, </span>
<span>    <span class="va">jack_estimate</span>, </span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span><span class="va">literacy</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># 標準誤差の計算</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>,</span>
<span>    se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">estimate</span> <span class="op">-</span> <span class="va">jack</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="va">literacy</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu">kable</span><span class="op">(</span><span class="va">handmade</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">literacy</th>
<th align="right">estimate</th>
<th align="right">se</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">pvlit1</td>
<td align="right">296.468</td>
<td align="right">0.549</td>
</tr>
<tr class="even">
<td align="left">pvlit2</td>
<td align="right">296.143</td>
<td align="right">0.529</td>
</tr>
<tr class="odd">
<td align="left">pvlit3</td>
<td align="right">296.184</td>
<td align="right">0.543</td>
</tr>
<tr class="even">
<td align="left">pvlit4</td>
<td align="right">296.111</td>
<td align="right">0.541</td>
</tr>
<tr class="odd">
<td align="left">pvlit5</td>
<td align="right">296.172</td>
<td align="right">0.522</td>
</tr>
<tr class="even">
<td align="left">pvlit6</td>
<td align="right">296.936</td>
<td align="right">0.543</td>
</tr>
<tr class="odd">
<td align="left">pvlit7</td>
<td align="right">295.561</td>
<td align="right">0.481</td>
</tr>
<tr class="even">
<td align="left">pvlit8</td>
<td align="right">296.827</td>
<td align="right">0.518</td>
</tr>
<tr class="odd">
<td align="left">pvlit9</td>
<td align="right">296.188</td>
<td align="right">0.521</td>
</tr>
<tr class="even">
<td align="left">pvlit10</td>
<td align="right">295.832</td>
<td align="right">0.542</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="結果の比較">結果の比較<a class="anchor" aria-label="anchor" href="#%E7%B5%90%E6%9E%9C%E3%81%AE%E6%AF%94%E8%BC%83"></a>
</h3>
<ul>
<li>結果は一致する</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>  <span class="va">package</span>, </span>
<span>  <span class="va">handmade</span>, </span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span><span class="va">literacy</span><span class="op">)</span>,</span>
<span>  suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'_package'</span>, <span class="st">'_handmade'</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">literacy</span>, <span class="va">estimate_package</span>, <span class="va">estimate_handmade</span>, <span class="va">se_package</span>, <span class="va">se_handmade</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    diff_estimate <span class="op">=</span> <span class="va">estimate_package</span> <span class="op">-</span> <span class="va">estimate_handmade</span>,</span>
<span>    diff_se <span class="op">=</span> <span class="va">se_package</span> <span class="op">-</span> <span class="va">se_handmade</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">kable</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="10%">
<col width="19%">
<col width="20%">
<col width="12%">
<col width="13%">
<col width="15%">
<col width="8%">
</colgroup>
<thead><tr class="header">
<th align="left">literacy</th>
<th align="right">estimate_package</th>
<th align="right">estimate_handmade</th>
<th align="right">se_package</th>
<th align="right">se_handmade</th>
<th align="right">diff_estimate</th>
<th align="right">diff_se</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">pvlit1</td>
<td align="right">296.468</td>
<td align="right">296.468</td>
<td align="right">0.549</td>
<td align="right">0.549</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">pvlit2</td>
<td align="right">296.143</td>
<td align="right">296.143</td>
<td align="right">0.529</td>
<td align="right">0.529</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">pvlit3</td>
<td align="right">296.184</td>
<td align="right">296.184</td>
<td align="right">0.543</td>
<td align="right">0.543</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">pvlit4</td>
<td align="right">296.111</td>
<td align="right">296.111</td>
<td align="right">0.541</td>
<td align="right">0.541</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">pvlit5</td>
<td align="right">296.172</td>
<td align="right">296.172</td>
<td align="right">0.522</td>
<td align="right">0.522</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">pvlit6</td>
<td align="right">296.936</td>
<td align="right">296.936</td>
<td align="right">0.543</td>
<td align="right">0.543</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">pvlit7</td>
<td align="right">295.561</td>
<td align="right">295.561</td>
<td align="right">0.481</td>
<td align="right">0.481</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">pvlit8</td>
<td align="right">296.827</td>
<td align="right">296.827</td>
<td align="right">0.518</td>
<td align="right">0.518</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">pvlit9</td>
<td align="right">296.188</td>
<td align="right">296.188</td>
<td align="right">0.521</td>
<td align="right">0.521</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">pvlit10</td>
<td align="right">295.832</td>
<td align="right">295.832</td>
<td align="right">0.542</td>
<td align="right">0.542</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="pvの統合">PVの統合<a class="anchor" aria-label="anchor" href="#pv%E3%81%AE%E7%B5%B1%E5%90%88"></a>
</h2>
<ul>
<li><p>読解力、数的思考力などは複数のPV（Plausible
Values）という形で測定</p></li>
<li><p>PVを用いた分析の結果は、多重代入法の要領で統合が可能<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Buuren, Stef van. 2018. &lt;em&gt;Flexible Imputation of
Missing Data&lt;/em&gt;. 2nd ed. New York: Chapman &amp;amp; Hall/CRC. &lt;a href="https://stefvanbuuren.name/fimd/" class="external-link uri"&gt;https://stefvanbuuren.name/fimd/&lt;/a&gt;&lt;/p&gt;'><sup>2</sup></a></p></li>
<li><p><code><a href="../reference/pool_rubin.html">kamaken::pool_rubin</a></code>を用いた統合</p></li>
<li><p>平均値</p></li>
</ul>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>θ</mi><mo accent="true">̂</mo></mover><mo>=</mo><mfrac><mn>1</mn><mi>M</mi></mfrac><munderover><mo>∑</mo><mrow><mi>m</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><msub><mover><mi>θ</mi><mo accent="true">̂</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>m</mi><mo stretchy="true" form="postfix">)</mo></mrow></msub></mrow><annotation encoding="application/x-tex">
\hat{\theta} = \frac{1}{M} \sum_{m=1}^{M} \hat{\theta}_{(m)}
</annotation></semantics></math></p>
<ul>
<li>各PVにおいて生じる分散の平均（分散の平均値）</li>
</ul>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>U</mi><mo accent="true">‾</mo></mover><mo>=</mo><mfrac><mn>1</mn><mi>M</mi></mfrac><munderover><mo>∑</mo><mrow><mi>m</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><msub><mover><mi>U</mi><mo accent="true">̂</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>m</mi><mo stretchy="true" form="postfix">)</mo></mrow></msub></mrow><annotation encoding="application/x-tex">
\bar{U} = \frac{1}{M} \sum_{m=1}^{M} \hat{U}_{(m)}
</annotation></semantics></math></p>
<ul>
<li>PV間で生じる分散（平均値の分散）</li>
</ul>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>=</mo><mfrac><mn>1</mn><mrow><mi>M</mi><mo>−</mo><mn>1</mn></mrow></mfrac><munderover><mo>∑</mo><mrow><mi>m</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>θ</mi><mo accent="true">̂</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>m</mi><mo stretchy="true" form="postfix">)</mo></mrow></msub><mo>−</mo><mover><mi>θ</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">
B = \frac{1}{M-1} \sum_{m=1}^{M} (\hat{\theta}_{(m)} - \hat{\theta})^2
</annotation></semantics></math></p>
<ul>
<li>統合された推定値の標準誤差</li>
</ul>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mrow><mi>S</mi><mi>E</mi></mrow><mo accent="true">̂</mo></mover><mo>=</mo><msqrt><mrow><mover><mi>U</mi><mo accent="true">‾</mo></mover><mo>+</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>+</mo><mfrac><mn>1</mn><mi>M</mi></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mi>B</mi></mrow></msqrt></mrow><annotation encoding="application/x-tex">
\hat{SE} = \sqrt{\bar{U} + \left(1 + \frac{1}{M}\right)B}
</annotation></semantics></math></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">handmade</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/pool_rubin.html">pool_rubin</a></span><span class="op">(</span>std.error <span class="op">=</span> <span class="va">se</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">kable</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">M</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
<th align="right">conf.low</th>
<th align="right">conf.high</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">10</td>
<td align="right">296.242</td>
<td align="right">0.685</td>
<td align="right">294.9</td>
<td align="right">297.585</td>
</tr></tbody>
</table>
</div>
<div class="section level2">
<h2 id="より複雑なケース">より複雑なケース<a class="anchor" aria-label="anchor" href="#%E3%82%88%E3%82%8A%E8%A4%87%E9%9B%91%E3%81%AA%E3%82%B1%E3%83%BC%E3%82%B9"></a>
</h2>
<div class="section level3">
<h3 id="因果効果の推定">因果効果の推定<a class="anchor" aria-label="anchor" href="#%E5%9B%A0%E6%9E%9C%E5%8A%B9%E6%9E%9C%E3%81%AE%E6%8E%A8%E5%AE%9A"></a>
</h3>
<ul>
<li>高等教育進学が読解力に与える因果効果の推定</li>
<li>G-computation<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Hernán, Miguel A. &amp;amp; James M. Robins, 2024,
&lt;em&gt;Causal Inference: What If&lt;/em&gt;, Boca Raton: Chapman &amp;amp; Hall/CRC.
&lt;a href="https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/" class="external-link uri"&gt;https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/&lt;/a&gt;&lt;/p&gt;'><sup>3</sup></a>によるATEの推定</li>
<li>
<code><a href="../reference/gcomp_jack.html">kamaken::gcomp_jack</a></code>による推定
<ul>
<li>
<code>.outcome</code>：アウトカム変数</li>
<li>
<code>.treatment</code>：0-1の二値変数</li>
<li>
<code>.formula_rhs</code>：回帰式の右辺を指定
<ul>
<li>
<code>~ treatment + covariate1 + covariate2 + ...</code>のような形</li>
<li>固定効果も指定可能：<code>~ 1 | treatment + fixed_effect1 + fixed_effect2 + ...</code>
</li>
<li>
<code>fixest</code>パッケージでの<code>formula</code>に準拠</li>
</ul>
</li>
<li>
<code>.estimand</code>：推定対象
<ul>
<li>
<code>cfmean</code>：<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">E</mi><mrow><mo stretchy="true" form="prefix">[</mo><msup><mi>Y</mi><mn>1</mn></msup><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">\mathrm{E}[Y^1]</annotation></semantics></math>と<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">E</mi><mrow><mo stretchy="true" form="prefix">[</mo><msup><mi>Y</mi><mn>0</mn></msup><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">\mathrm{E}[Y^0]</annotation></semantics></math>
</li>
<li>
<code>ATE</code>：平均処置効果</li>
</ul>
</li>
<li>
<code>.weights</code>：サンプリングウェイト</li>
<li>
<code>.repweights</code>：ジャックナイフ法に用いるreplicate
weights</li>
<li>
<code>.type</code>：ジャックナイフ法のタイプ</li>
<li>
<code>.by</code>：効果の異質性を見たい変数を指定（<code>NULL</code>なら集団全体）</li>
</ul>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="推定結果">推定結果<a class="anchor" aria-label="anchor" href="#%E6%8E%A8%E5%AE%9A%E7%B5%90%E6%9E%9C"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 並列化</span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="st">'multisession'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">26</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/gcomp_jack.html">gcomp_jack</a></span><span class="op">(</span></span>
<span>    .outcome <span class="op">=</span> <span class="va">pvlit1</span>,</span>
<span>    .treatment <span class="op">=</span> <span class="va">univ</span>,</span>
<span>    .formula_rhs <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">univ</span><span class="op">^</span><span class="va">gender</span><span class="op">^</span><span class="va">agegroup</span>,</span>
<span>    .estimand <span class="op">=</span> <span class="st">'ATE'</span>,</span>
<span>    .weights <span class="op">=</span> <span class="va">sampling_weight</span>,</span>
<span>    .repweights <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">'spfwt'</span><span class="op">)</span>,</span>
<span>    .type <span class="op">=</span> <span class="st">'JK2'</span>,</span>
<span>    .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">gender</span>, <span class="va">agegroup</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">kable</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">estimand</th>
<th align="left">gender</th>
<th align="left">agegroup</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">ATE</td>
<td align="left">Male</td>
<td align="left">26-30</td>
<td align="right">26.590</td>
<td align="right">4.692</td>
</tr>
<tr class="even">
<td align="left">ATE</td>
<td align="left">Male</td>
<td align="left">31-35</td>
<td align="right">24.986</td>
<td align="right">4.766</td>
</tr>
<tr class="odd">
<td align="left">ATE</td>
<td align="left">Male</td>
<td align="left">36-40</td>
<td align="right">28.109</td>
<td align="right">3.835</td>
</tr>
<tr class="even">
<td align="left">ATE</td>
<td align="left">Male</td>
<td align="left">41-45</td>
<td align="right">28.916</td>
<td align="right">3.917</td>
</tr>
<tr class="odd">
<td align="left">ATE</td>
<td align="left">Male</td>
<td align="left">46-50</td>
<td align="right">30.594</td>
<td align="right">4.789</td>
</tr>
<tr class="even">
<td align="left">ATE</td>
<td align="left">Male</td>
<td align="left">51-55</td>
<td align="right">35.483</td>
<td align="right">5.616</td>
</tr>
<tr class="odd">
<td align="left">ATE</td>
<td align="left">Male</td>
<td align="left">56-60</td>
<td align="right">38.366</td>
<td align="right">5.703</td>
</tr>
<tr class="even">
<td align="left">ATE</td>
<td align="left">Male</td>
<td align="left">61-65</td>
<td align="right">24.382</td>
<td align="right">4.711</td>
</tr>
<tr class="odd">
<td align="left">ATE</td>
<td align="left">Female</td>
<td align="left">26-30</td>
<td align="right">22.546</td>
<td align="right">3.546</td>
</tr>
<tr class="even">
<td align="left">ATE</td>
<td align="left">Female</td>
<td align="left">31-35</td>
<td align="right">24.534</td>
<td align="right">3.581</td>
</tr>
<tr class="odd">
<td align="left">ATE</td>
<td align="left">Female</td>
<td align="left">36-40</td>
<td align="right">27.753</td>
<td align="right">4.466</td>
</tr>
<tr class="even">
<td align="left">ATE</td>
<td align="left">Female</td>
<td align="left">41-45</td>
<td align="right">34.266</td>
<td align="right">4.167</td>
</tr>
<tr class="odd">
<td align="left">ATE</td>
<td align="left">Female</td>
<td align="left">46-50</td>
<td align="right">23.310</td>
<td align="right">4.708</td>
</tr>
<tr class="even">
<td align="left">ATE</td>
<td align="left">Female</td>
<td align="left">51-55</td>
<td align="right">32.056</td>
<td align="right">5.081</td>
</tr>
<tr class="odd">
<td align="left">ATE</td>
<td align="left">Female</td>
<td align="left">56-60</td>
<td align="right">26.026</td>
<td align="right">4.619</td>
</tr>
<tr class="even">
<td align="left">ATE</td>
<td align="left">Female</td>
<td align="left">61-65</td>
<td align="right">40.169</td>
<td align="right">10.041</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="個のpvに対して一括で推定">10個のPVに対して一括で推定<a class="anchor" aria-label="anchor" href="#%E5%80%8B%E3%81%AEpv%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6%E4%B8%80%E6%8B%AC%E3%81%A7%E6%8E%A8%E5%AE%9A"></a>
</h3>
<ul>
<li>
<code><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">purrr::map</a></code>などで、変数名を変えながら繰り返し推定する</li>
<li>注意点として、外部の文字列ベクトルで<code>.outcome</code>を指定しようとするとエラーが生じる。<code>!!</code>や<code>{{</code>を用いてunquoteする。</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 読解力PVの変数名を取得</span></span>
<span><span class="va">pvs</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">'pvlit'</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span></span>
<span>    <span class="va">pvs</span>,</span>
<span>    \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/gcomp_jack.html">gcomp_jack</a></span><span class="op">(</span></span>
<span>      .data <span class="op">=</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">26</span><span class="op">)</span>,</span>
<span>      <span class="co"># mapで回すときは`!!`または`{{`を使う</span></span>
<span>      .outcome <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="va">x</span>,</span>
<span>      <span class="co"># .outcome = {{x}},</span></span>
<span>      .treatment <span class="op">=</span> <span class="va">univ</span>,</span>
<span>      .formula_rhs <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">univ</span><span class="op">^</span><span class="va">gender</span><span class="op">^</span><span class="va">agegroup</span>,</span>
<span>      .estimand <span class="op">=</span> <span class="st">'ATE'</span>,</span>
<span>      .weights <span class="op">=</span> <span class="va">sampling_weight</span>,</span>
<span>      .repweights <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">'spfwt'</span><span class="op">)</span>,</span>
<span>      .type <span class="op">=</span> <span class="st">'JK2'</span>,</span>
<span>      .by <span class="op">=</span> <span class="va">gender</span></span>
<span>    <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">'pv'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 20 × 5</span></span></span>
<span><span class="co">##    pv    estimand gender estimate std.error</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> 1     ATE      Male       29.4      1.61</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> 1     ATE      Female     29.2      2.01</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> 2     ATE      Male       29.8      1.78</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> 2     ATE      Female     29.7      1.98</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> 3     ATE      Male       29.4      1.76</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> 3     ATE      Female     29.6      2.13</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> 4     ATE      Male       32.2      1.73</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> 4     ATE      Female     32.3      2.16</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> 5     ATE      Male       30.6      1.71</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> 5     ATE      Female     29.8      1.82</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">11</span> 6     ATE      Male       30.5      1.67</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">12</span> 6     ATE      Female     29.7      2.06</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">13</span> 7     ATE      Male       30.4      1.78</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">14</span> 7     ATE      Female     31.0      1.80</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">15</span> 8     ATE      Male       30.0      1.84</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">16</span> 8     ATE      Female     31.2      1.91</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">17</span> 9     ATE      Male       32.1      1.66</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">18</span> 9     ATE      Female     31.3      2.17</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">19</span> 10    ATE      Male       30.8      1.60</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">20</span> 10    ATE      Female     32.7      1.81</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="結果の統合">結果の統合<a class="anchor" aria-label="anchor" href="#%E7%B5%90%E6%9E%9C%E3%81%AE%E7%B5%B1%E5%90%88"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/pool_rubin.html">pool_rubin</a></span><span class="op">(</span>term <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">estimand</span>, <span class="va">gender</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">kable</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">estimand</th>
<th align="left">gender</th>
<th align="right">M</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
<th align="right">conf.low</th>
<th align="right">conf.high</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">ATE</td>
<td align="left">Male</td>
<td align="right">10</td>
<td align="right">30.526</td>
<td align="right">1.996</td>
<td align="right">26.613</td>
<td align="right">34.439</td>
</tr>
<tr class="even">
<td align="left">ATE</td>
<td align="left">Female</td>
<td align="right">10</td>
<td align="right">30.643</td>
<td align="right">2.364</td>
<td align="right">26.011</td>
<td align="right">35.276</td>
</tr>
</tbody>
</table>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kentaro Kamada.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
